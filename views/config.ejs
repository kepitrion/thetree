<style>
#evalOutputParent {
    width: 100%;
    height: 200px;
    resize: vertical;
}

.static-file {
    width: 50%;
}

.delete-file {
    float: right;
}
</style>

<script>
document.addEventListener('thetree:pageLoad', () => {
    const evalOutput = document.getElementById('evalOutput');
    const evalContent = document.getElementById('evalContent');
    const evalRun = document.getElementById('evalRun');

    evalRun.addEventListener('click', async () => {
        if(!evalContent.value) return;

        const response = await fetch('/admin/config/eval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                code: evalContent.value
            }).toString()
        });
        evalOutput.innerHTML = await response.text();
    });

    evalContent.addEventListener('keydown', e => {
        if(!e.shiftKey && e.key === 'Enter') {
            e.preventDefault();
            evalRun.click();
        }
    })
}, { once: true });
</script>

<div class="wiki-content">
    <h2 class="wiki-heading">도구</h2>
    <div class="wiki-heading-content">
        <a class="thetree-button thetree-primary-button" href="/admin/config/tools/getgrant">grant 권한 받기</a>
    </div>

    <h2 class="wiki-heading wiki-heading-folded">Eval</h2>
    <div class="wiki-heading-content wiki-heading-content-folded">
        <pre id="evalOutputParent"><code id="evalOutput"></code></pre>
        <textarea id="evalContent" rows="5"></textarea>
        <button id="evalRun" class="thetree-button thetree-primary-button">실행</button>
    </div>

    <h2 class="wiki-heading">설정</h2>
    <div class="wiki-heading-content">
        <%for(let config of [
            'publicConfig.json',
            'serverConfig.json'
        ]) {%>
        <h3 class="wiki-heading wiki-heading-folded"><%=config%></h3>
        <div class="wiki-heading-content wiki-heading-content-folded">
            <form method="post" action="/admin/config/configjson">
                <input type="hidden" name="config" value="<%=config%>">
                <textarea name="content" rows="15"><%-fs.readFileSync(config)%></textarea>
                <button class="thetree-button thetree-primary-button configApplyButtons">적용</button>
            </form>
        </div>
        <%}%>

        <h3 class="wiki-heading wiki-heading-folded">텍스트</h3>
        <div class="wiki-heading-content wiki-heading-content-folded">
            <a class="thetree-button thetree-primary-button" href="/admin/config/tools/fixstringconfig">stringConfig.example.json 필드 추가</a>

            <form method="post" action="/admin/config/stringconfig">
                <%for(let [key, value] of Object.entries(stringConfig)) {%>
                    <p><%=key%></p>
                    <textarea name="<%=key%>" rows="10"><%-value%></textarea>
                <%}%>
                <button class="thetree-button thetree-primary-button">적용</button>
            </form>
        </div>
    </div>

    <h2 class="wiki-heading">정적 파일</h2>
    <div class="wiki-heading-content">
        <%for(let file of customStaticFiles) {%>
            <p class="static-file">
                <a href="<%=file%>" target="_blank"><%=file%></a>
                <a class="thetree-square-button thetree-danger-button delete-file" href="/admin/config/tools/deletestaticfile?path=<%=file%>">삭제</a>
            </p>
        <%}%>

        <hr>

        <form method="post" action="/admin/config/staticfile" enctype="multipart/form-data">
            <input name="path" placeholder="경로" value="/" required>
            <input name="filename" placeholder="파일 이름">
            <input type="file" name="file" required>
            <button class="thetree-button thetree-primary-button">업로드</button>
        </form>
    </div>
</div>